name: Keep Streamlit App Alive

on:
  schedule:
    # Chạy mỗi 6 tiếng (0:00, 6:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch: # Cho phép chạy thủ công

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Streamlit App
        run: |
          set +e  # Không thoát khi có lỗi
          echo "Pinging Streamlit app to keep it alive..."
          
          # Lấy URL từ secrets
          APP_URL="${{ secrets.STREAMLIT_APP_URL }}"
          
          if [ -z "$APP_URL" ]; then
            echo "⚠️ STREAMLIT_APP_URL secret chưa được thiết lập!"
            echo "Vui lòng thêm URL ứng dụng vào GitHub Secrets"
            exit 1
          fi
          
          echo "Target URL: $APP_URL"
          
          # Gửi request đến ứng dụng với timeout 30s
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 "$APP_URL" || echo "000")
          
          echo "Response code: $RESPONSE"
          
          # Kiểm tra response code (dùng regex để tránh lỗi so sánh số)
          if [[ "$RESPONSE" =~ ^(200|301|302)$ ]]; then
            echo "✅ App is alive and responding!"
            exit 0
          elif [[ "$RESPONSE" == "000" ]]; then
            echo "⚠️ Failed to connect to app (timeout or network error)"
            echo "This is normal if the app is sleeping. It should wake up now."
            exit 0
          else
            echo "⚠️ App returned status code: $RESPONSE"
            echo "App might be sleeping or having issues, but the ping should wake it up."
            exit 0
          fi
          
      - name: Log timestamp
        run: |
          echo "Last ping: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
